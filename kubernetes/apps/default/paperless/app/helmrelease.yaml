---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app paperless
spec:
  timeout: 5m
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: *app
  values:
    controllers:
      paperless:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: ghcr.io/paperless-ngx/paperless-ngx
              tag: 2.20.7@sha256:7b937cb2fa2885ab0ecfceb8c7e8827e2312472d9d897a270097ba7f5522dcdc
            env:
              # USERMAP_UID: &uid 1000
              # USERMAP_GID: *uid
              # General Settings
              PAPERLESS_TIME_ZONE: America/Chicago
              PAPERLESS_APP_TITLE: "Document Archive"
              PAPERLESS_URL: "https://{{ .Release.Name }}.${INTERNAL_SECRET_DOMAIN}"
              PAPERLESS_PORT: &port 8000
              # Tika/Gotenberg Settings
              PAPERLESS_TIKA_ENABLED: 1
              PAPERLESS_TIKA_GOTENBERG_ENDPOINT: http://paperless-gotenburg.default.svc:3000
              PAPERLESS_TIKA_ENDPOINT: http://paperless-tika.default.svc:9998
              # PostgreSQL Settings
              PAPERLESS_DBENGINE: postgresql
              PAPERLESS_DBHOST: postgres-rw.database.svc
              PAPERLESS_DBNAME: paperless
              PAPERLESS_DBUSER: paperless
              PAPERLESS_DBSSLMODE: verify-full
              PAPERLESS_DBSSLROOTCERT: /var/run/secrets/postgresql/ca.crt
              PAPERLESS_DBSSLCERT: /var/run/secrets/postgresql/tls.crt
              PAPERLESS_DBSSLKEY: /var/run/secrets/postgresql/tls.key
              PAPERLESS_DB_POOLSIZE: 1
              # Redis Settings
              PAPERLESS_REDIS: "redis://dragonfly.database.svc:6379/13"
              # File Consumption Settings
              PAPERLESS_CONSUMER_POLLING: 60
              PAPERLESS_DATE_PARSER_LANGUAGES: en
              # Email Settings
              PAPERLESS_EMAIL_USE_TLS: true
              # Barcode Settings
              PAPERLESS_CONSUMER_ENABLE_BARCODES: true
              PAPERLESS_CONSUMER_ENABLE_ASN_BARCODE: true
              PAPERLESS_CONSUMER_ASN_BARCODE_PREFIX: ASN
              PAPERLESS_CONSUMER_ENABLE_TAG_BARCODE: true
              PAPERLESS_CONSUMER_TAG_BARCODE_MAPPING: '{"ASN01.*": "ASN-01", "ASN02.*": "ASN-02"}'
            envFrom:
              - secretRef:
                  name: "{{ .Release.Name }}-secret"
            probes:
              liveness: &probes
                enabled: false
                type: HTTP
              readiness: *probes
              startup:
                enabled: false
                type: HTTP
                spec:
                  failureThreshold: 30
                  periodSeconds: 5
            # securityContext: &sc
            #   allowPrivilegeEscalation: false
            #   readOnlyRootFilesystem: true
            #   capabilities: {drop: ["ALL"]}
            resources:
              requests:
                cpu: 508m
                memory: 2409Mi
              limits:
                memory: 2409Mi
      gotenburg:
        containers:
          app:
            image:
              repository: ghcr.io/mchestr/gotenberg
              tag: 8.17.3
            resources:
              requests:
                cpu: 10m
                memory: 483Mi
              limits:
                memory: 483Mi
            env:
              DISABLE_GOOGLE_CHROME: "1"
            # securityContext: *sc
      tika:
        containers:
          app:
            image:
              repository: docker.io/apache/tika
              tag: 3.2.3.0-full
            # securityContext: *sc
            resources:
              requests:
                cpu: 10m
                memory: 413Mi
              limits:
                memory: 413Mi
    defaultPodOptions:
      hostUsers: true
      securityContext:
        # runAsNonRoot: true
        # runAsUser: *uid
        # runAsGroup: *uid
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        # seccompProfile: { type: "RuntimeDefault" }
    service:
      paperless:
        controller: *app
        ports:
          http:
            port: *port
      gotenburg:
        controller: gotenburg
        ports:
          http:
            port: 3000
      tika:
        controller: tika
        ports:
          http:
            port: 9998

    route:
      app:
        hostnames:
          - "{{ .Release.Name }}.${INTERNAL_SECRET_DOMAIN}"
        parentRefs:
          - name: internal
            namespace: kube-system
            sectionName: https
        rules:
          - backendRefs:
              - name: *app
                port: *port
    persistence:
      config:
        existingClaim: "{{ .Release.Name }}"
        advancedMounts:
          paperless:
            app:
              - path: "/usr/src/paperless/data"
      media:
        type: nfs
        server: 192.168.20.21
        path: /mnt/tank/services/paperless
        advancedMounts:
          paperless:
            app:
              - path: "/usr/src/paperless/media"
                subPath: media
              - path: "/usr/src/paperless/consume"
                subPath: consume
              - path: "/usr/src/paperless/export"
                subPath: export
      # tmp:
      #   type: emptyDir
      #   medium: Memory
      #   sizeLimit: 16Mi
      #   globalMounts:
      #     - subPath: tmp
      #       path: /tmp
      #   advancedMounts:
      #     paperless:
      #       app:
      #         - subPath: "run"
      #           path: "/run"
      #         - subPath: "apt"
      #           path: "/var/lib/apt"
